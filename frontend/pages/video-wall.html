<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    .layui-tree-iconClick .layui-icon-file::before {
      content: "\e6ed" !important;
      /* layui-icon-video çš„ Unicode */
      color: #23292e;
      /* å¯é€‰ï¼šè®¾ç½®é¢œè‰² */
      font-size: 16px;
      /* å¯é€‰ï¼šè°ƒæ•´å¤§å° */
      margin-right: 0;
      /* å¯é€‰ï¼šå¾®è°ƒé—´è· */
    }

    #ID_videowall_container.layout-1 {
      grid-template-rows: 1fr;
      grid-template-columns: 1fr;
    }

    #ID_videowall_container.layout-4 {
      grid-template-rows: 1fr 1fr;
      grid-template-columns: 1fr 1fr;
    }

    #ID_videowall_container.layout-9 {
      grid-template-rows: 1fr 1fr 1fr;
      grid-template-columns: 1fr 1fr 1fr;
    }

    #ID_videowall_container.layout-16 {
      grid-template-rows: 1fr 1fr 1fr 1fr;
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    .video-cell {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: #2f363c;
      overflow: hidden;
    }

    .video-cell video {
      width: 100%;
      height: 100%;
      background-color: #2f363c;
      object-fit: cover;
      border: 1px solid #e7e7e7;
      box-sizing: border-box;
    }

    .video-cell .video-status {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      align-items: center;
      color: #eeeeee;
      font-weight: 500;
      font-size: 18px;
    }

    .video-cell .video-btns {
      position: absolute;
      top: 10px;
      /* è·ç¦»é¡¶éƒ¨ 10px */
      right: 10px;
      /* è·ç¦»å³ä¾§ 10px */
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 10;
      display: flex;
      flex-direction: column;
      gap: 10px;
      /* é˜²æ­¢ç‚¹å‡»ç©¿é€ */
      pointer-events: auto;
    }

    .video-cell:hover .video-btns {
      opacity: 1;
    }
  </style>
</head>

<body>
  <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
  <div style="
        display: flex;
        justify-content: center;
        align-items: center;
        height: 120px;
      ">
    <div class="layui-btn-group">
      <button class="layui-btn" id="ID_single">å•å±</button>
      <button class="layui-btn" id="ID_quad">å››åˆ†å±</button>
      <button class="layui-btn" id="ID_nine">ä¹åˆ†å±</button>
      <button class="layui-btn" id="ID_fullscreen">
        <i class="layui-icon layui-icon-screen-full"></i>
      </button>
    </div>
  </div>

  <!-- è§†é¢‘å¢™ -->
  <div style="display: flex; justify-content: center; margin: 0">
    <div id="ID_videowall_container" style="width: 960px; height: 540px; display: grid"></div>
  </div>

  <!-- æµIDæ ‘ -->
  <script id="ID_tpl_layer" type="text/html">
      <div id="ID_streamid_tree" style="margin: 12px;"></div>
    </script>

  <script>
    layui.use(function () {
      let layer = layui.layer;
      let tree = layui.tree;
      let $ = layui.jquery;

      let nowVideoCells = [];

      // å±å¹•å•å…ƒæŠ½è±¡
      function VideoCell(container, index) {
        this.container = container; //  æŒ‚è½½åˆ° ID_videowall_container

        this.index = index; // åˆ†å±ç´¢å¼•

        this.element = null;
        this.player = null; // WebRTC è¿æ¥å®ä¾‹

        this.init();
      }

      VideoCell.prototype.init = function () {
        // åˆ›å»º DOM å…ƒç´ 
        this.element = document.createElement("div");
        this.element.className = "video-cell";
        this.element.innerHTML = `<video autoplay muted></video>
                                      <div class="video-status"></div>
                                      <div class="video-btns">
                                        <button class="layui-btn config-btn layui-btn-sm" style="background-color: #16baaa; margin: 0" data-index="${this.index}">é…ç½®</button>
                                        <button class="layui-btn reset-btn layui-btn-sm" style="background-color: #ff5722; margin: 0" data-index="${this.index}">é‡ç½®</button>
                                      </div>`;

        // å°†åˆ›å»ºçš„ DOM æ·»åŠ åˆ°çˆ¶å®¹å™¨
        this.container.appendChild(this.element);

        this.bindEvents();
      };

      VideoCell.prototype.bindEvents = function () {
        // é…ç½®æŒ‰é’®: æ‰“å¼€æ ‘å½¢é€‰æ‹©å¼¹å±‚
        let configBtn = this.element.querySelector(".config-btn");
        configBtn.addEventListener("click", () => this.openLayer());
        // é‡ç½®æŒ‰é’®: å…³é—­ webrtc è¿æ¥å¹¶åœæ­¢æ’­æ”¾
        let resetBtn = this.element.querySelector(".reset-btn");
        resetBtn.addEventListener("click", () => this.stopPlay());

        // æ’­æ”¾çŠ¶æ€
        let video = this.element.querySelector("video");
        let statusEl = this.element.querySelector(".video-status");

        // æ˜¾ç¤º Loading...
        function showLoading() {
          statusEl.textContent = "Loading...";
          statusEl.style.display = "flex";
        }

        // éšè—çŠ¶æ€
        function hideStatus() {
          statusEl.style.display = "none";
        }

        // æ’­æ”¾å¼€å§‹åŠ è½½æ—¶ï¼Œæ˜¾ç¤º loading
        video.addEventListener("loadstart", showLoading);
        video.addEventListener("waiting", showLoading);
        // çœŸæ­£å¼€å§‹æ’­æ”¾ï¼Œéšè—çŠ¶æ€
        video.addEventListener("playing", hideStatus);
        video.addEventListener("canplay", hideStatus);
      };

      VideoCell.prototype.openLayer = function () {
        let self = this;

        layer.open({
          type: 1,
          title: "æµIDæ ‘ï¼ˆRTSPï¼‰",
          area: ["300px", "324px"],
          content: $("#ID_tpl_layer").html(),
          success: function (layero, index) {
            $.ajax({
              url: "/api/stream/streamid-list?schema=rtsp",
              method: "GET",
              success: function (res) {
                if (res.code === 0) {
                  function toTreeData(data) {
                    const map = new Map();

                    data.forEach((item) => {
                      const app = item.app;
                      const stream = item.stream;

                      const info = { app, stream };

                      if (!map.has(app)) {
                        map.set(app, {
                          title: app,
                          children: [],
                        });
                      }

                      const appNode = map.get(app);

                      appNode.children.push({
                        title: stream,
                        channelInfo: info,
                      });
                    });

                    return Array.from(map.values());
                  }

                  let treeData = toTreeData(res.data);
                  console.log(treeData);

                  // æ¸²æŸ“æ ‘
                  tree.render({
                    elem: "#ID_streamid_tree",
                    data: treeData,
                    click: function (obj) {
                      if (obj.data.channelInfo) {
                        // console.log(`æ’­æ”¾ ${obj.data.channelInfo.app} çš„ ${obj.data.channelInfo.stream} æµ`);

                        self.stopPlay();
                        self.player = new ZLMRTCClient.Endpoint({
                          element: self.element.querySelector("video"),
                          debug: true,
                          zlmsdpUrl: `/index/api/webrtc?app=${obj.data.channelInfo.app}&stream=${obj.data.channelInfo.stream}&type=play`,
                          recvOnly: true,
                          videoEnable: true, // å¯ç”¨è§†é¢‘
                          audioEnable: false, // å¯ç”¨éŸ³é¢‘
                          simulcast: false, // å¯ç”¨å¤šæµç¼–ç 
                          usedatachannel: false,
                        });

                        self.player.on(
                          ZLMRTCClient.Events.WEBRTC_ON_REMOTE_STREAMS,
                          (stream) => {
                            layer.msg("âœ… WebRTC æ’­æ”¾æˆåŠŸ", {
                              time: 1500,
                              offset: "t",
                              shift: 1,
                            });
                          }
                        );
                        self.player.on(
                          ZLMRTCClient.Events
                            .WEBRTC_OFFER_ANWSER_EXCHANGE_FAILED,
                          (e) => {
                            // layer.msg("âŒ OFFER ANWSER äº¤æ¢å¤±è´¥", {
                            //     time: 1500,
                            //     offset: "t",
                            //     shift: 1,
                            // });
                            console.log("âŒ OFFER ANWSER äº¤æ¢å¤±è´¥", e);
                            self.player.close();
                            self.player = null;
                            self.video.srcObject = null;
                            self.video.load();
                          }
                        );

                        self.player.on(
                          ZLMRTCClient.Events.WEBRTC_ICE_CANDIDATE_ERROR,
                          (e) => {
                            console.log("âŒ ICE é”™è¯¯", e);
                          }
                        );
                        self.player.on(
                          ZLMRTCClient.Events
                            .WEBRTC_ON_CONNECTION_STATE_CHANGE,
                          (state) => {
                            console.log("ğŸ”— RTC çŠ¶æ€:", state);
                          }
                        );

                        layer.close(index);
                      }
                    },
                  });
                }
              },
            });
          },
        });
      };

      VideoCell.prototype.stopPlay = function () {
        if (this.player) {
          this.player.close();
          this.player = null;
        }
        let video = this.element.querySelector("video");
        if (video) {
          video.srcObject = null;
          video.load();
        }
        console.log(`[å±å¹•${this.index}] æ’­æ”¾å·²åœæ­¢`);
      };

      window.destroyVideoCells = function () {
        if (nowVideoCells.length > 0) {
          nowVideoCells.forEach((cell) => {
            // åœæ­¢æ’­æ”¾
            cell.stopPlay();
            // ç§»é™¤ DOM å…ƒç´ 
            if (cell.element && cell.element.parentNode) {
              cell.element.parentNode.removeChild(cell.element);
            }
          });
        }
        nowVideoCells = [];
      };

      function setLayout(num) {
        // åœæ­¢æ’­æ”¾å¹¶æ¸…ç©ºç°æœ‰å±å¹•
        if (nowVideoCells.length > 0) {
          nowVideoCells.forEach((cell) => {
            // åœæ­¢æ’­æ”¾
            cell.stopPlay();
            // ç§»é™¤ DOM å…ƒç´ 
            if (cell.element && cell.element.parentNode) {
              cell.element.parentNode.removeChild(cell.element);
            }
          });
        }
        nowVideoCells = [];

        let container = document.getElementById("ID_videowall_container");
        // è®¾ç½®å¸ƒå±€ï¼šç§»é™¤æ—§ classï¼Œæ·»åŠ æ–° class
        container.className = ""; // æ¸…ç©º class
        container.classList.add(`layout-${num}`);

        // åˆ›å»ºå±å¹•å®ä¾‹
        for (let i = 0; i < num; i++) {
          nowVideoCells.push(new VideoCell(container, i));
        }
      }

      // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–
      document.addEventListener("fullscreenchange", () => {
        let container = document.getElementById("ID_videowall_container");
        let btns = container?.querySelectorAll(".video-btns");

        if (!container || !btns) return;

        if (document.fullscreenElement === container) {
          // container æ­£åœ¨å…¨å± â†’ éšè—æŒ‰é’®
          btns.forEach((btn) => {
            btn.style.display = "none";
          });
        } else {
          // ä¸æ˜¯å…¨å± æˆ– å…¶ä»–å…ƒç´ å…¨å± â†’ æ˜¾ç¤ºæŒ‰é’®
          btns.forEach((btn) => {
            btn.style.display = "flex"; // æ¢å¤é»˜è®¤ display
          });
        }
      });

      function fullscreen(elem) {
        if (!elem) {
          console.error("å…ƒç´ æœªæ‰¾åˆ°");
          return;
        }

        if (!document.fullscreenElement) {
          // è¿›å…¥å…¨å±
          elem.requestFullscreen().catch((err) => {
            console.error("å…¨å±å¤±è´¥:", err);
          });
        } else {
          // é€€å‡ºå…¨å±
          document.exitFullscreen();
        }
      }

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document
        .getElementById("ID_single")
        .addEventListener("click", () => setLayout(1));
      document
        .getElementById("ID_quad")
        .addEventListener("click", () => setLayout(4));
      document
        .getElementById("ID_nine")
        .addEventListener("click", () => setLayout(9));
      document
        .getElementById("ID_fullscreen")
        .addEventListener("click", () =>
          fullscreen(document.getElementById("ID_videowall_container"))
        );

      // é»˜è®¤å¸ƒå±€
      setLayout(4);
    });
  </script>
</body>

</html>