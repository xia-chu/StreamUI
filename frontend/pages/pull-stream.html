<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    .layui-form-item {
      margin: 20px 50px;
    }

    .layui-table-cell .layui-form-switch {
      display: block;
      width: 45px;
    }

    .layui-form-switch {
      margin-right: 5px;
    }

    .custom-switch {
      /* display: inline-flex; */
      display: block;
      align-items: center;
      cursor: pointer;
      user-select: none;
      color: #555;
      margin: auto;
    }

    .custom-switch .switch-track {
      width: 36px;
      height: 20px;
      background: #ddd;
      border-radius: 14px;
      padding: 2px;
      transition: background 0.3s ease;
      position: relative;
    }

    .custom-switch .switch-thumb {
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* å¼€å¯çŠ¶æ€ */
    .custom-switch[data-status="on"] .switch-track {
      background: #16b777;
    }

    .custom-switch[data-status="on"] .switch-thumb {
      transform: translateX(8px);
    }

    .custom-switch[data-status="off"] .switch-thumb {
      transform: translateX(-7px);
    }
  </style>
</head>

<body>
  <!-- <div style="padding: 16px 16px 0 16px">
    <div class="layui-card">
      <div class="layui-card-body" style="padding: 12px 16px;">
        <div> -->
  <!-- <button
              class="layui-btn"
              id="ID_pull_onvif_btn"
              style="background-color: #16baaa"
              type="button"
            >
              ONVIFæ¥å…¥
            </button> -->
  <!-- <button class="layui-btn" id="ID_pull_url_btn" style="background-color: #16baaa" type="button">
            æ·»åŠ 
          </button>
        </div>
      </div>
    </div>
  </div> -->

  <div style="padding: 16px">
    <div class="layui-card">
      <!-- <div class="layui-card-header">æµIDåˆ—è¡¨</div> -->
      <div class="layui-card-body" style="padding: 16px 16px;">
        <div class="layui-form"
          style="padding-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
          <div class="layui-inline">
            <div class="layui-input-inline" style="width: 200px; margin-right: 16px">
              <input type="text" id="ID_searchApp" placeholder="æœç´¢åº”ç”¨å" class="layui-input" />
            </div>
            <div class="layui-input-inline" style="width: 200px; margin-right: 16px">
              <input type="text" id="ID_searchStream" placeholder="æœç´¢æµID" class="layui-input" />
            </div>
            <div class="layui-input-inline" style="width: 140px; margin-right: 16px">
              <select id="ID_searchStatus">
                <option value="all" selected>å…¨éƒ¨çŠ¶æ€</option>
                <option value="online">ä»…åœ¨çº¿</option>
                <option value="offline">ä»…ç¦»çº¿</option>
              </select>
            </div>
            <button type="button" class="layui-btn" style="background-color: #16baaa" id="ID_table_btnSearch">
              æœç´¢
            </button>
            <button type="button" class="layui-btn layui-btn-primary" id="ID_table_btnReset">
              é‡ç½®
            </button>
            <button type="button" class="layui-btn layui-btn-primary" id="ID_pull_help_btn">
              è¯´æ˜
            </button>
          </div>
          <div>
            <button type="button" class="layui-btn" style="background-color: #16baaa" id="ID_pull_url_btn">
              <i class="layui-icon layui-icon-addition"></i> æ·»åŠ 
            </button>
          </div>
        </div>

        <table class="layui-hide" id="ID_streams_table"></table>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ  æ¨¡æ¿ -->
  <script id="ID_tpl_pull_url" type="text/html">
      <form id="ID_active_pull_form" class="layui-form" action="">
        <!-- æºæµåœ°å€ -->
        <div class="layui-form-item">
          <label class="layui-form-label">æºæµåœ°å€</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="url"
              required
              placeholder="è¯·è¾“å…¥æºæµåœ°å€ï¼Œæ”¯æŒ RTSP / RTMP / FLV / HLS / TS ..."
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- è™šæ‹Ÿä¸»æœº -->
        <input type="hidden" name="vhost" value="__defaultVhost__" />

        <!-- åº”ç”¨å -->
        <div class="layui-form-item">
          <label class="layui-form-label">åº”ç”¨å</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="app"
              value="live"
              required
              placeholder="è®¾ç½®ä¸€ä¸ªåº”ç”¨å"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

        <!-- æµID -->
        <div class="layui-form-item">
          <label class="layui-form-label">æµID</label>
          <div class="layui-input-block">
            <input
              type="text"
              name="stream"
              required
              placeholder="ä¸ºè¯¥æµè®¾ç½®ä¸€ä¸ªæµID"
              autocomplete="off"
              class="layui-input"
            />
          </div>
        </div>

       

        <!-- éŸ³é¢‘ -->
        <div class="layui-form-item">
          <label class="layui-form-label">éŸ³é¢‘è®¾ç½®</label>
          <div class="layui-input-block">
            <select name="audio_type">
              <option value="0">ä¸è½¬å‘éŸ³é¢‘</option>
              <option value="1">è½¬å‘åŸéŸ³é¢‘</option>
              <option value="2">è½¬å‘é™éŸ³éŸ³é¢‘</option>
            </select>
          </div>
        </div>

        <!-- æäº¤è¡¨å•æŒ‰é’® -->
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              æäº¤
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </form>
    </script>

  <!-- toolbar æ¨¡æ¿ -->
  <script id="ID_tpl_toolbar" type="text/html">
      <a
        class="layui-btn"
        lay-event="play"
        style="background-color: #16baaa; height: 26px;line-height: 26px;"
        >é¢„è§ˆ</a
      >
      <a
        class="layui-btn"
        lay-event="del"
        style="background-color: #ff5722; height: 26px;line-height: 26px;"
        >åˆ é™¤</a
      >
    </script>

  <!-- player æ¨¡æ¿ -->
  <script id="ID_tpl_player" type="text/html">
      <div
        style="display: flex;justify-content: center;align-items: center; margin: 16px 16px 0 16px; flex-direction: column;"
      >
        <div style=" position: relative;">
          <video
            id="ID_player"
            autoplay
            style="width:960px; height:540px; background-color: #2f363c;"
          ></video>
          <div
            id="ID_status"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; align-items: center; color: #eeeeee; font-weight: 500; font-size: 18px;"
          ></div>
        </div>
        <div id="ID_tabs" style="margin-top: 16px;"></div>
      </div>
    </script>

  <!-- record æ¨¡æ¿ -->
  <script id="ID_tpl_record" type="text/html">
      <form id="ID_record_form" class="layui-form" action="">
        <!-- å½•åƒ -->
        <div class="layui-form-item">
          <label class="layui-form-label">å½•åƒä¿ç•™(å¤©)</label>
          <div class="layui-input-block">
            <input
              type="number"
              name="record_days"
              value="1"
              autocomplete="off"
              class="layui-input"
              min="1"
              step="1"
              lay-affix="number"
            />
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="submit" class="layui-btn" id="btn_submit">
              æäº¤
            </button>
            <button
              type="button"
              class="layui-btn layui-btn-primary"
              id="btn_cancel"
            >
              å–æ¶ˆ
            </button>
          </div>
        </div>
      </form>
    </script>

  <script>
    layui.use(["table", "layer", "form", "tabs", "jquery"], function () {
      let table = layui.table;
      let layer = layui.layer;
      let form = layui.form;
      let tabs = layui.tabs;
      let $ = layui.jquery;

      // æ¸²æŸ“è¡¨æ ¼
      function renderTable() {
        const app = $("#ID_searchApp").val().trim();
        const stream = $("#ID_searchStream").val().trim();
        const status = $("#ID_searchStatus").val();

        $.ajax({
          url: `/api/stream/pull-proxy-table?app=${encodeURIComponent(
            app
          )}&stream=${encodeURIComponent(stream)}`,
          type: "GET",
          dataType: "json",
          timeout: 10000,
          success: function (res) {
            if (res.code !== 0) {
              layer.msg("âŒ æ‹‰æµåˆ—è¡¨è·å–å¤±è´¥", {
                time: 1500,
                offset: "t",
                shift: 1,
              });
              return;
            }

            let tableData = res.data || [];
            if (status === "online") {
              tableData = tableData.filter((item) => !!item.isOnline);
            } else if (status === "offline") {
              tableData = tableData.filter((item) => !item.isOnline);
            }

            table.render({
              elem: "#ID_streams_table",
              data: tableData,
              cols: [
                [
                  {
                    field: "id",
                    title: "åºå·",
                    align: "center",
                    width: 80,
                    templet: function (d) {
                      return d.LAY_NUM;
                    },
                  },
                  {
                    field: "app",
                    title: "åº”ç”¨å",
                    align: "center",
                    width: 120,
                  },
                  {
                    field: "stream",
                    title: "æµID",
                    align: "center",
                    width: 180,
                  },
                  {
                    field: "isOnline",
                    title: "åœ¨çº¿",
                    align: "center",
                    width: 120,
                    templet: function (d) {
                      const icon = d.isOnline
                        ? "/assets/signal.svg"
                        : "/assets/nosignal%20.svg";
                      const alt = d.isOnline ? "online" : "offline";
                      return `<img src="${icon}" alt="${alt}" style="width:18px;height:18px;" />`;
                    },
                  },
                  {
                    field: "url",
                    title: "æºæµåœ°å€",
                    align: "center",
                    minWidth: 300,
                    templet: function (d) {
                      return `<span>${d.url}</span>`;
                    },
                  },
                  {
                    field: "rePullCount",
                    title: "é‡è¿æ¬¡æ•°",
                    align: "center",
                    width: 120,
                  },
                  {
                    field: "aliveSecond",
                    title: "æ—¶é•¿",
                    align: "center",
                    width: 120,
                    templet: function (d) {
                      if (d.aliveSecond === "-") {
                        return "-";
                      }

                      let seconds = d.aliveSecond;
                      let h = Math.floor(seconds / 3600);
                      let m = Math.floor((seconds % 3600) / 60);
                      let s = seconds % 60;
                      return (
                        (h < 10 ? "0" + h : h) +
                        ":" +
                        (m < 10 ? "0" + m : m) +
                        ":" +
                        (s < 10 ? "0" + s : s)
                      );
                    },
                  },
                  {
                    field: "isRecordingMP4",
                    title: "å½•åˆ¶",
                    align: "center",
                    width: 120,
                    templet: function (d) {
                      if (d.isRecordingMP4 === "-") {
                        return "-";
                      }

                      let checked = d.isRecordingMP4 ? "checked" : "";

                      return `<div style="display: flex;justify-content: center;align-items: center; width: 100%; height: 100%;">
                                <div class="custom-switch" lay-event="toggleRecord" data-vhost="${d.vhost
                        }" data-app="${d.app}" data-stream="${d.stream
                        }" data-status="${d.isRecordingMP4 ? "on" : "off"}">
                                  <div class="switch-track">
                                    <div class="switch-thumb"></div>
                                  </div>
                                </div>
                              </div>`;
                    },
                  },

                  {
                    field: "totalReaderCount",
                    title: "æ€»è§‚çœ‹äººæ•°",
                    align: "center",
                    width: 120,
                  },
                  {
                    field: "schemas",
                    title: "è½¬åè®®",
                    align: "center",
                    minWidth: 150,
                    templet: function (d) {
                      if (d.schemas === "-") {
                        return "-";
                      }

                      const schemaConfig = [
                        { key: "rtsp", name: "RTSP" },
                        { key: "rtmp", name: "RTMP" },
                        { key: "hls", name: "HLS" },
                        { key: "hls.fmp4", name: "HLS-fMP4" },
                        { key: "ts", name: "HTTP-TS" },
                        { key: "fmp4", name: "HTTP-fMP4" },
                        { key: "webrtc", name: "WebRTC" },
                        { key: "rtc", name: "RTC" },
                      ];

                      let enabledSchemas = Array.isArray(d.schemas)
                        ? d.schemas.map((item) => item.schema)
                        : [];

                      let uniqueSchemas = [...new Set(enabledSchemas)];

                      if (uniqueSchemas.length === 0) {
                        return '<span class="layui-badge layui-bg-gray" style="font-size:14px;border-radius:5px;">æ— </span>';
                      }

                      return uniqueSchemas
                        .map((schema) => {
                          let config = schemaConfig.find((p) => p.key === schema);
                          let displayName = config ? config.name : schema.toUpperCase();
                          return `<span class="layui-badge" style="margin-right: 4px; font-size: 14px; background-color: #31bdec; border-radius: 5px">${displayName}</span>`;
                        })
                        .join("");
                    },
                  },
                  {
                    field: "operate",
                    title: "æ“ä½œ",
                    width: 200,
                    align: "center",
                    fixed: "right",
                    toolbar: "#ID_tpl_toolbar",
                  },
                ],
              ],
              page: true,
              limits: [8, 16, 32],
              limit: 8,
            });
          },
          error: function () {
            layer.msg("âŒ æ‹‰æµåˆ—è¡¨è¯·æ±‚å¤±è´¥", {
              time: 1500,
              offset: "t",
              shift: 1,
            });
          },
        });
      }

      // ç›‘å¬è¡¨æ ¼æŒ‰é’®
      table.on("tool(ID_streams_table)", function (obj) {
        let data = obj.data; // å½“å‰è¡Œæ•°æ®
        let layEvent = obj.event; // è·å– lay-event çš„å€¼ï¼ˆdel, playï¼‰

        if (layEvent === "play") {
          let playerElement = null;
          let statusElement = null;

          layer.open({
            type: 1,
            title: "é¢„è§ˆ",
            area: ["1000px", "100%"],
            content: $("#ID_tpl_player").html(),
            btn: [],
            shadeClose: true,
            success: function () {
              playerElement = document.getElementById("ID_player");
              statusElement = document.getElementById("ID_status");

              let hasfMP4 = Array.isArray(data.schemas)
                ? data.schemas.some((item) => item.schema === "fmp4")
                : false;

              if (!hasfMP4) {
                if (statusElement) {
                  statusElement.textContent = "è¯·åœ¨è®¾ç½®ä¸­å¼€å¯ HTTP-fMP4 åˆ†å‘";
                  statusElement.style.display = "flex";
                }
              } else {
                let stopped = false;
                let retryCount = 0;
                let retryTimer = null;
                let waitingTimer = null;

                const baseUrl = `http://${window.location.hostname}:8080/${encodeURIComponent(
                  data.app
                )}/${encodeURIComponent(data.stream)}.live.mp4`;

                const showStatus = (text) => {
                  if (!statusElement) return;
                  statusElement.textContent = text || "";
                  statusElement.style.display = "flex";
                };

                const hideStatus = () => {
                  if (!statusElement) return;
                  statusElement.style.display = "none";
                };

                const clearTimers = () => {
                  if (retryTimer !== null) {
                    clearTimeout(retryTimer);
                    retryTimer = null;
                  }
                  if (waitingTimer !== null) {
                    clearTimeout(waitingTimer);
                    waitingTimer = null;
                  }
                };

                const buildUrlWithTs = () => {
                  const ts = Date.now();
                  return baseUrl.indexOf("?") >= 0
                    ? `${baseUrl}&_t=${ts}`
                    : `${baseUrl}?_t=${ts}`;
                };

                const scheduleReconnect = () => {
                  if (stopped || !playerElement) return;
                  clearTimers();

                  const retryIndex = Math.min(retryCount, 6);
                  const baseDelay = Math.min(15000, 1000 * Math.pow(2, retryIndex));
                  const jitter = Math.floor(Math.random() * 300);
                  const delay = baseDelay + jitter;

                  showStatus("ç¦»çº¿ï¼Œé‡è¿ä¸­...");

                  retryTimer = setTimeout(() => {
                    retryTimer = null;
                    if (stopped || !playerElement) return;

                    const url = buildUrlWithTs();
                    playerElement.pause();
                    playerElement.src = url;
                    playerElement.load();
                    const p = playerElement.play();
                    if (p && typeof p.catch === "function") {
                      p.catch(() => {});
                    }
                    retryCount += 1;
                  }, delay);
                };

                const onPlaying = () => {
                  retryCount = 0;
                  clearTimers();
                  hideStatus();
                };
                const onCanPlay = () => {
                  hideStatus();
                };
                const onWaiting = () => {
                  if (stopped) return;
                  if (waitingTimer !== null) return;
                  waitingTimer = setTimeout(() => {
                    waitingTimer = null;
                    scheduleReconnect();
                  }, 4000);
                };
                const onError = () => scheduleReconnect();
                const onStalled = () => scheduleReconnect();
                const onEnded = () => scheduleReconnect();

                playerElement.addEventListener("playing", onPlaying);
                playerElement.addEventListener("canplay", onCanPlay);
                playerElement.addEventListener("waiting", onWaiting);
                playerElement.addEventListener("error", onError);
                playerElement.addEventListener("stalled", onStalled);
                playerElement.addEventListener("ended", onEnded);

                playerElement.src = buildUrlWithTs();
                playerElement.load();
                showStatus("è¿æ¥ä¸­...");
                const p = playerElement.play();
                if (p && typeof p.catch === "function") {
                  p.catch(() => {});
                }

                playerElement.__streamui_cleanup__ = () => {
                  stopped = true;
                  clearTimers();
                  playerElement.removeEventListener("playing", onPlaying);
                  playerElement.removeEventListener("canplay", onCanPlay);
                  playerElement.removeEventListener("waiting", onWaiting);
                  playerElement.removeEventListener("error", onError);
                  playerElement.removeEventListener("stalled", onStalled);
                  playerElement.removeEventListener("ended", onEnded);
                };
              }

              let schemaConfig = {
                rtsp: {
                  name: "RTSP",
                  port: 8554,
                  url: `rtsp://${window.location.hostname}:8554/${data.app}/${data.stream}`,
                },
                rtmp: {
                  name: "RTMP",
                  port: 1935,
                  url: `rtmp://${window.location.hostname}:1935/${data.app}/${data.stream}`,
                },
                hls: {
                  name: "HLS",
                  port: 8080,
                  url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}/hls.m3u8`,
                },
                "hls.fmp4": {
                  name: "HLS-fMP4",
                  port: 8080,
                  url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}/hls.fmp4.m3u8`,
                },
                ts: {
                  name: "HTTP-TS",
                  port: 8080,
                  url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}.live.ts`,
                },
                fmp4: {
                  name: "HTTP-fMP4",
                  port: 8080,
                  url: `http://${window.location.hostname}:8080/${data.app}/${data.stream}.live.mp4`,
                },
              };

              let headers = [];
              let bodies = [];

              (Array.isArray(data.schemas) ? data.schemas : [])
                .filter((item) => item.schema) // ç¡®ä¿ schema å­˜åœ¨
                .forEach((item) => {
                  let schema = item.schema;
                  let tracks = item.tracks || [];
                  let bytesSpeed = item.bytesSpeed || 0;
                  let readerCount = item.readerCount || 0;
                  let totalBytes = item.totalBytes || 0;

                  // æ ¼å¼åŒ–æµé‡å•ä½ï¼ˆB, KB, MB, GBï¼‰
                  function formatBytes(bytes) {
                    if (bytes === 0) return "0 B";
                    const k = 1024;
                    const sizes = ["B", "KB", "MB", "GB"];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return (
                      parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                      " " +
                      sizes[i]
                    );
                  }

                  // æ„å»ºè½¨é“ä¿¡æ¯ HTML
                  let trackHtml = `<div style='line-height: 1.8;'>è½¨é“ä¿¡æ¯ï¼š<br>`;
                  if (tracks.length === 0) {
                    trackHtml += `<span>æ— è½¨é“ä¿¡æ¯</span><br>`;
                  } else {
                    tracks.forEach((track) => {
                      let type =
                        track.codec_type === 0
                          ? "Video"
                          : track.codec_type === 1
                            ? "Audio"
                            : "Other";

                      let detail = "";
                      if (track.codec_type === 0) {
                        // è§†é¢‘
                        detail = `ç¼–ç  ${track.codec_id_name}ï¼Œåˆ†è¾¨ç‡ ${track.width
                          }x${track.height}@${track.fps || "?"}FPSï¼ŒGOP ${track.gop_size
                          } (${track.gop_interval_ms}ms)`;
                      } else if (track.codec_type === 1) {
                        // éŸ³é¢‘
                        detail = `ç¼–ç  ${track.codec_id_name}ï¼Œ${track.sample_rate}Hzï¼Œ${track.channels}å£°é“`;
                      } else {
                        detail = `ç¼–ç  ${track.codec_id_name || "Unknown"}`;
                      }
                      trackHtml += `<span>ã€${type}ã€‘${detail}</span><br>`;
                    });
                  }
                  trackHtml += "</div>";

                  // æ„å»ºè½¬å‘åœ°å€ä¸ç»Ÿè®¡ä¿¡æ¯
                  let config = schemaConfig[schema] || {
                    name: schema.toUpperCase(),
                    url: "#",
                  };
                  let protocolName = config.name;
                  let forwardUrl = config.url;

                  // ç»Ÿè®¡ä¿¡æ¯
                  let statsHtml = `
                                    <div style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 13px;">
                                      ğŸŒ å½“å‰ç ç‡: ${(
                      (bytesSpeed * 8) /
                      1048576
                    ).toFixed(2)} Mbpsï¼Œ
                                      ğŸ‘¤ å½“å‰åœ¨çº¿: ${readerCount} äººï¼Œ
                                      ğŸ“¦ æ€»æµé‡: ${formatBytes(totalBytes)}
                                    </div>`;

                  let copyCode = `copyToClipboard('${forwardUrl}')`;

                  let html = `
                                <div style="font-size: 14px; color: #333;">

                                  ${trackHtml}
                                  ${statsHtml}

                                  <div style="margin-top: 10px;">
                                    è½¬å‘åœ°å€ï¼ˆç‚¹å‡»å¤åˆ¶ï¼‰ï¼š<br>
                                    <span
                                      onclick="${copyCode}"
                                      title="ç‚¹å‡»å¤åˆ¶"
                                      style="
                                        display: inline-block;
                                        margin-top: 4px;
                                        padding: 6px 10px;
                                        background: #f0f0f0;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        cursor: pointer;
                                        font-family: monospace;
                                        font-size: 13px;
                                        word-break: break-all;
                                      "
                                    >
                                      ${forwardUrl}
                                    </span>
                                  </div>
                                </div>`;

                  headers.push({ title: protocolName });
                  bodies.push({ content: html });
                });

              // å¦‚æœæ²¡æœ‰ä»»ä½•åè®®è¢«å¯ç”¨
              if (bodies.length === 0) {
                headers.push({ title: "æ— å¯ç”¨åè®®" });
                bodies.push({
                  content: `<div style="color: #999; text-align: center; padding: 20px;">å½“å‰æµæœªå¼€å¯ä»»ä½•åè®®è½¬å‘</div>`,
                });
              }

              // æ¸²æŸ“ Tabs
              tabs.render({
                elem: "#ID_tabs",
                header: headers,
                body: bodies,
              });
            },

            end: function () {
              if (playerElement) {
                if (typeof playerElement.__streamui_cleanup__ === "function") {
                  playerElement.__streamui_cleanup__();
                  playerElement.__streamui_cleanup__ = null;
                }
                playerElement.pause();
                playerElement.removeAttribute("src");
                playerElement.load();
              }
            },
          });
        } else if (layEvent === "del") {
          // åˆ é™¤ç¡®è®¤
          layer.confirm(
            `ç¡®å®šè¦åˆ é™¤<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${data.app} / ${data.stream}</span>å—?`,
            {
              title: "æç¤º",
            },
            function (index) {
              // æ‰§è¡Œåˆ é™¤è¯·æ±‚
              $.ajax({
                url: `/api/stream/pull-proxy?vhost=${encodeURIComponent(
                  data.vhost
                )}&app=${encodeURIComponent(data.app)}&stream=${encodeURIComponent(
                  data.stream
                )}`,
                type: "DELETE",
                success: function (res) {
                  console.log(res);

                  if (res.code === 0) {
                    layer.msg("âœ… åˆ é™¤æˆåŠŸ", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                    renderTable();
                  }
                },
              });

              layer.close(index); // å…³é—­å¼¹çª—
            }
          );
        } else if (layEvent === "toggleRecord") {
          let vhost = data.vhost;
          let app = data.app;
          let stream = data.stream;
          let isRecord = data.isRecordingMP4;

          if (isRecord) {
            layer.confirm(
              `ç¡®å®šè¦åœæ­¢<span style = "margin-bottom: 6px; padding: 4px; background: #f7f7f7; border-radius: 4px;">${app} / ${stream}</span>å½•åƒå—?`,
              {
                title: "æç¤º",
              },
              function (index) {
                $.ajax({
                  url: `/api/playback/stop-record?vhost=${vhost}&app=${app}&stream=${stream}`,
                  type: "GET",
                  success: function (res) {
                    if (res.code === 0) {
                      layer.msg("âœ… å½•åƒå·²åœæ­¢", {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                      renderTable();
                    } else {
                      layer.msg("âš ï¸ " + res.msg, {
                        time: 1500,
                        offset: "t",
                        shift: 1,
                      });
                    }
                  },
                });
                layer.close(index); // å…³é—­å¼¹çª—
              }
            );
          } else {
            layer.open({
              type: 1,
              title: "å¼€å¯å½•åƒ",
              area: ["500px", "auto"],
              content: $("#ID_tpl_record").html(),
              btn: null,
              shadeClose: true,
              success: function (layero, index) {
                form.render();

                layero.find("#btn_submit").on("click", function (e) {
                  e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰

                  let $form = layero.find("#ID_record_form");

                  let formData = {};
                  $form.find("input, select").each(function () {
                    let $el = $(this);
                    let name = $el.attr("name");
                    if (!name) return true; // elem æ²¡æœ‰ name å°±è·³è¿‡

                    let value;
                    if ($el.is(":checkbox")) {
                      // å¤„ç† checkboxï¼šchecked æ—¶å– valueï¼Œå¦åˆ™ä¸º 'false'
                      value = $el.is(":checked") ? "true" : "false";
                    } else {
                      value = $el.val();
                    }

                    formData[name] = value;
                  });

                  if (
                    !/^\d+$/.test(formData["record_days"]) ||
                    parseInt(formData["record_days"], 10) < 0 ||
                    parseInt(formData["record_days"], 10) > 30
                  ) {
                    layer.msg("âš ï¸ å½•åƒå¤©æ•°å»ºè®®ä¸è¦è¶…è¿‡30å¤©", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                    return false;
                  }
                  // å‘é€è¯·æ±‚
                  $.ajax({
                    url: `/api/playback/start-record?vhost=${vhost}&app=${app}&stream=${stream}&record_days=${formData["record_days"]}`,
                    type: "GET",
                    timeout: 5000,
                    success: function (res) {
                      if (res.code === 0) {
                        layer.msg("âœ… å¼€å§‹å½•åƒ", {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                        setTimeout(() => {
                          layer.close(index);
                        }, 400);
                      } else {
                        layer.msg("âš ï¸ " + res.msg, {
                          time: 1500,
                          offset: "t",
                          shift: 1,
                        });
                      }
                      renderTable();
                    },
                  });
                });

                layero.find("#btn_cancel").on("click", function () {
                  layer.close(index);
                });
              },
              end: function () {
                // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
                renderTable();
              },
            });
          }
        }
      });

      // ç›‘å¬æ·»åŠ æŒ‰é’®
      $("#ID_pull_url_btn").on("click", function () {
        layer.open({
          type: 1,
          title: "æ·»åŠ ",
          area: ["700px", "400px"],
          content: $("#ID_tpl_pull_url").html(),
          shadeClose: true,
          btn: null,
          success: function (layero, index) {
            // æ¸²æŸ“ layui è¡¨å•æ§ä»¶ï¼ˆå¦‚ä¸‹æ‹‰æ¡†ã€å¼€å…³ï¼‰
            form.render();

            // è¡¨å•æäº¤
            layero.find("#btn_submit").on("click", function (e) {
              e.preventDefault(); // é˜»æ­¢é»˜è®¤æäº¤ï¼ˆé˜²æ­¢é¡µé¢åˆ·æ–°ï¼‰

              // è·å–è¡¨å•
              let $form = layero.find("#ID_active_pull_form");

              // å¿…å¡«é¡¹éªŒè¯
              let isValid = true;
              $form.find("input[required]").each(function () {
                let val = $(this).val();
                if (!val || val.trim() === "") {
                  const name = $(this).attr("name");
                  const nameMap = {
                    url: "æºæµåœ°å€",
                    app: "åº”ç”¨å",
                    stream: "æµID",
                  };
                  const fieldLabel = nameMap[name] || "å¿…å¡«é¡¹";

                  layer.msg("âš ï¸ è¯·å¡«å†™ï¼š" + fieldLabel, {
                    time: 1500,
                    offset: "t",
                    shift: 1,
                  });

                  $(this).focus();
                  isValid = false;
                  return false; // è·³å‡º each å¾ªç¯
                }
              });
              if (!isValid) return false;

              let formData = {};
              $form.find("input, select").each(function () {
                let $el = $(this);
                let name = $el.attr("name");
                if (!name) return true;

                let value;
                if ($el.is(":checkbox")) {
                  value = $el.is(":checked") ? "true" : "false";
                } else {
                  value = $el.val();
                }

                formData[name] = value;
              });

              $.ajax({
                url: `/api/stream/pull-proxy?vhost=${encodeURIComponent(
                  formData.vhost || "__defaultVhost__"
                )}&app=${encodeURIComponent(formData.app)}&stream=${encodeURIComponent(
                  formData.stream
                )}&url=${encodeURIComponent(formData.url)}&audio_type=${encodeURIComponent(
                  formData.audio_type
                )}`,
                type: "POST",
                timeout: 5000,
                success: function (res) {
                  if (res.code === 0) {
                    layer.msg("âœ… æ·»åŠ æˆåŠŸ", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                    renderTable();
                    setTimeout(() => {
                      renderTable();
                    }, 3000);
                    setTimeout(() => {
                      renderTable();
                    }, 10000);
                    setTimeout(() => {
                      layer.close(index);
                    }, 300);
                  } else {
                    layer.msg("âš ï¸ " + res.msg, {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  }
                },
              });
            });

            // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
            layero.find("#btn_cancel").on("click", function () {
              layer.close(index);
            });
          },
          end: function () {
            // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
            setTimeout(() => {
              renderTable();
            }, 300);
          },
        });
      });

      // ç›‘å¬onvifæ¥å…¥æŒ‰é’®
      $("#ID_pull_onvif_btn").on("click", function () {
        layer.open({
          type: 1,
          title: "ONVIFæ¥å…¥",
          area: ["700px", "100%"],
          content: $("#ID_tpl_pull_onvif").html(),
          shadeClose: true,
          btn: null,
          success: function (layero, index) {
            let $layer = $(layero);

            // è·å–è®¾å¤‡ä¿¡æ¯æŒ‰é’®
            $layer.find("#btn_fetch_device").on("click", function () {
              let ip = $layer.find('[name="onvif-cameraip"]').val().trim();
              let port = $layer.find('[name="onvif-port"]').val().trim();
              let user = $layer.find('[name="onvif-username"]').val().trim();
              let pwd = $layer.find('[name="onvif-password"]').val().trim();

              if (!ip || !user || !pwd) {
                layer.msg("âš ï¸ è¯·å¡«å†™å®Œæ•´çš„æ‘„åƒæœºä¿¡æ¯", {
                  time: 1500,
                  offset: "t",
                  shift: 1,
                });
                return;
              }

              let loading = layer.load(2, { shade: [0.1, "#fff"] });

              $.ajax({
                url: `/api/onvif/profiles?cameraip=${ip}&port=${port}&username=${user}&password=${pwd}`, // æ›¿æ¢ä¸ºä½ çš„å®é™…æ¥å£
                method: "GET",
                success: function (res) {
                  layer.close(loading);

                  if (res.code === 0 && res.data?.profiles?.length > 0) {
                    let dev = res.data.device_info;
                    $layer
                      .find("#device_manufacturer")
                      .text(dev.manufacturer || "-");
                    $layer.find("#device_model").text(dev.model || "-");
                    $layer
                      .find("#device_firmware")
                      .text(dev.firmware_version || "-");
                    $layer
                      .find("#device_serial")
                      .text(dev.serial_number || "-");

                    // æ¸…ç©ºå¹¶å¡«å……ç æµé€‰é¡¹
                    let $select = $layer.find("#profile_select");
                    $select
                      .empty()
                      .append('<option value="">è¯·é€‰æ‹©ç æµ</option>');
                    res.data.profiles.forEach(function (p) {
                      let label = `${p.name} (${p.video.width}x${p.video.height}@${p.video.framerate}fps, ${p.video.encoding})`;
                      $select.append(
                        `<option value="${p.token}" data-url="${p.rtsp_url}">${label}</option>`
                      );
                    });

                    $layer.find("#device_info_area").show();
                    layui.form.render("select"); // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰æ¡†
                  } else {
                    layer.msg("âŒ è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥ " + res.msg, {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  }
                },
                error: function () {
                  layer.msg("âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¥å£", {
                    time: 1500,
                    offset: "t",
                    shift: 1,
                  });
                },
              });
            });

            // ç›‘å¬ç æµé€‰æ‹©
            layui.form.on("select(profile_select)", function (data) {
              let $layer = $(data.elem)
                .closest(".layui-layer-content")
                .parent();
              let selectedOption = $(data.elem).find("option:selected");
              let url = selectedOption.data("url");

              if (url) {
                console.log("é€‰æ‹©äº† ", url);

                // æ˜¾ç¤ºåç»­è¡¨å•é¡¹
                $layer.find("#app_item").show();
                $layer.find("#stream_item").show();
                $layer.find("#audio_item").show();
                $layer.find("#submit_btns").show();

                // å¯é€‰ï¼šè‡ªåŠ¨å¡«å……æµIDï¼ˆä¾‹å¦‚ä»RTSPä¸­æå–ï¼‰
                // æ­¤å¤„ç•™ç©ºï¼Œç”±ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
              } else {
                console.log("æœªé€‰æ‹©");

                $layer.find("#app_item").hide();
                $layer.find("#stream_item").hide();
                $layer.find("#audio_item").hide();
                $layer.find("#submit_btns").hide();
              }
            });

            // å–æ¶ˆæŒ‰é’®
            $layer.find("#btn_cancel").on("click", function () {
              layer.close(index);
            });

            // è¡¨å•æäº¤
            $layer.find("#ID_active_pull_form").on("submit", function (e) {
              e.preventDefault();

              // æ”¶é›†æ‰€æœ‰æ•°æ®
              let formData = {};
              $(this)
                .serializeArray()
                .forEach(function (item) {
                  formData[item.name] = item.value;
                });

              // æ·»åŠ  url
              let selectedToken = formData["selected_profile_token"];
              if (selectedToken) {
                let url = $layer
                  .find(`#profile_select option[value="${selectedToken}"]`)
                  .data("url");
                formData.url = url;
              }

              // è¿™é‡Œå¯ä»¥æäº¤åˆ°ä½ çš„æ‹‰æµæ¥å£
              // console.log("æäº¤æ•°æ®ï¼š", formData);
              $.ajax({
                url: `/api/stream/pull-proxy?vhost=${encodeURIComponent(
                  formData.vhost || "__defaultVhost__"
                )}&app=${encodeURIComponent(formData.app)}&stream=${encodeURIComponent(
                  formData.stream
                )}&url=${encodeURIComponent(formData.url)}&audio_type=${encodeURIComponent(
                  formData.audio_type
                )}`,
                type: "POST",
                timeout: 5000,
                success: function (res) {
                  if (res.code === 0) {
                    layer.msg("âœ… æ·»åŠ æˆåŠŸ", {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                    renderTable();
                    setTimeout(() => {
                      renderTable();
                    }, 3000);
                    setTimeout(() => {
                      renderTable();
                    }, 10000);
                    setTimeout(() => {
                      layer.close(index);
                    }, 300);
                  } else {
                    layer.msg("âš ï¸ " + res.msg, {
                      time: 1500,
                      offset: "t",
                      shift: 1,
                    });
                  }
                },
              });
            });
          },
          end: function () {
            // ç›‘å¬å¼¹çª—å…³é—­å°±åˆ·æ–°è¡¨æ ¼
            setTimeout(() => {
              renderTable();
            }, 300);
          },
        });
      });

      // ç›‘å¬è¡¨æ ¼æœç´¢æŒ‰é’®
      $("#ID_table_btnSearch").on("click", function () {
        renderTable();
      });

      // ç›‘å¬è¡¨æ ¼é‡ç½®æŒ‰é’®
      $("#ID_table_btnReset").on("click", function () {
        $("#ID_searchApp").val("");
        $("#ID_searchStream").val("");
        $("#ID_searchStatus").val("all");
        form.render("select");
        renderTable();
      });

      $("#ID_searchStatus").on("change", function () {
        renderTable();
      });

      $("#ID_pull_help_btn").on("click", function () {
        layer.open({
          type: 1,
          title: "æ‹‰æµæ¥å…¥è¯´æ˜",
          area: ["720px", "420px"],
          shadeClose: true,
          btn: [],
          content: `
            <div style="padding: 16px; line-height: 1.8;">
              <div style="font-weight: 600; margin-bottom: 8px;">ä»€ä¹ˆæ˜¯æ‹‰æµæ¥å…¥ï¼Ÿ</div>
              <div style="margin-bottom: 12px;">
                æ‹‰æµæ¥å…¥æŒ‡æŠŠä¸€æ¡â€œå·²æœ‰çš„ç›´æ’­æµåœ°å€â€ï¼ˆä¾‹å¦‚ RTSP/RTMP/FLV/HLS/TSï¼‰æ¥å…¥åˆ°æœ¬å¹³å°ã€‚å¹³å°ä¼šåœ¨æœåŠ¡ç«¯ä¸»åŠ¨å»æ‹‰å–è¿™æ¡æºæµï¼Œ
                å¹¶ç”Ÿæˆä¸€ä¸ªæœ¬åœ°çš„ä»£ç†æµï¼ˆä½ å¯ä»¥ç”¨â€œåº”ç”¨å + æµIDâ€æ¥æ ‡è¯†ï¼‰ï¼Œä»è€Œåœ¨å¹³å°å†…è¿›è¡Œé¢„è§ˆã€åˆ†å‘ã€å½•åƒç­‰åç»­æ“ä½œã€‚
              </div>

              <div style="font-weight: 600; margin-bottom: 8px;">æ€ä¹ˆç”¨ï¼Ÿ</div>
              <div style="margin-bottom: 12px;">
                ç‚¹å‡»å³ä¾§â€œæ·»åŠ â€ï¼Œå¡«å†™ç›´æ’­æµåœ°å€ã€åº”ç”¨åã€æµIDï¼Œå¹¶é€‰æ‹©éŸ³é¢‘è®¾ç½®ï¼Œç„¶åæäº¤å³å¯ã€‚
                åº”ç”¨å/æµID ç»„åˆå»ºè®®ä¿æŒå”¯ä¸€ï¼Œä¾¿äºç®¡ç†å’Œæ£€ç´¢ã€‚
              </div>

              <div style="font-weight: 600; margin-bottom: 8px;">å¸¸è§æ³¨æ„äº‹é¡¹</div>
              <ul style="margin: 0; padding-left: 18px;">
                <li>ç¡®ä¿æºæµåœ°å€åœ¨æœåŠ¡ç«¯å¯è®¿é—®ï¼ˆç½‘ç»œã€é˜²ç«å¢™ã€è´¦å·å¯†ç ç­‰ï¼‰ã€‚</li>
                <li>åŒä¸€åº”ç”¨å/æµID é‡å¤å¯èƒ½å¯¼è‡´è¦†ç›–æˆ–æ–°å¢å¤±è´¥ã€‚</li>
                <li>æºæµä¸ç¨³å®šæ—¶ï¼Œå¹³å°ç«¯è¡¨ç°ä¸ºç¦»çº¿/é‡è¿æ¬¡æ•°å¢åŠ ã€‚</li>
              </ul>
            </div>
          `,
        });
      });

      // åˆå§‹åŒ–
      $("#ID_searchApp").val("");
      $("#ID_searchStream").val("");
      $("#ID_searchStatus").val("all");
      form.render("select");
      renderTable();
    });
  </script>
</body>

</html>
